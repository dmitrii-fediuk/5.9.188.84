env:
  DISCOURSE_DEVELOPER_EMAILS: 'admin@mage2.pro'
  DISCOURSE_HOSTNAME: 'mage2.pro'
  DISCOURSE_SMTP_ADDRESS: smtp.postmarkapp.com
  DISCOURSE_SMTP_ENABLE_START_TLS: true
  DISCOURSE_SMTP_PORT: 587
  DISCOURSE_SMTP_USER_NAME: PM-T-outbound-85ylSjsEQpLZm674rSpbSi
  LANG: en_US.UTF-8 # 2020-09-05 https://meta.discourse.org/t/151236#lc-collate-values-for-database-%E2%80%9Cpostgres%E2%80%9D-do-not-match
  LANGUAGE: en_US.UTF-8
  LC_ALL: en_US.UTF-8
  my: 'https://github.com/discourse-pro/'
  UNICORN_WORKERS: 4
expose:
  - "14580:5432" # PostgreSQL
  - "2224:22" # SSH
  - "4580:80"
hooks:
  after_code:
    - exec:
        cd: $home/plugins
        cmd:
          - mkdir -p plugins
          - git clone https://github.com/discourse/discourse-post-voting
          - git clone https://github.com/discourse/discourse-solved
          - git clone https://github.com/discourse/discourse-vk-auth
           # «The docker manager plugin allows you to one-click upgrade Discourse»
          - git clone https://github.com/discourse/docker_manager
          - git clone ${my}df-core
          - git clone ${my}df-core-private
          #- git clone ${my}df-github-blob-onebox
          - git clone ${my}df-qa
          - git clone ${my}russian-localization
params:
  db_default_text_search_config: "pg_catalog.english"
  ## Set db_shared_buffers to a max of 25% of the total memory.
  ## On 1GB installs set to 128MB (to leave room for other processes)
  ## on a 4GB instance you may raise to 1GB
  # 2018-01-23 "The default Discourse's `db_shared_buffers` value is 256Mb": https://discourse.pro/t/283
  db_shared_buffers: "1GB"
  ## Set higher on large instances it defaults to 10MB, for a 3GB install 40MB is a good default
  ## this improves sorting performance, but adds memory usage per-connection
  db_work_mem: "40MB"
  upload_size: 60m # 2018-06-18 https://meta.discourse.org/t/26435/2
  version: tests-passed
run:
  - exec: echo "Beginning of custom commands"
  # 2022-08-14 «Installing a Theme programatically»: https://meta.discourse.org/t/191843
  - file:
      path: /tmp/mythemes.yml
      # 2022-08-14 «DiscoTOC - automatic table of contents»: https://meta.discourse.org/t/111143
      contents: |
        toc:
          url: https://github.com/discourse/DiscoTOC.git
          add_to_all_themes: true
  - exec:
      cd: $home
      cmd: su discourse -c 'bundle exec rake themes:install < /tmp/mythemes.yml'
  - exec: echo "End of custom commands"
  - exec: awk -F\# '{print $1;}' ~/.ssh/authorized_keys | awk 'BEGIN { print "Authorized SSH keys for this container:"; } NF>=2 {print $NF;}'
templates:
# 2024-05-30
# "Consolidate the sensitive data from all Discourse YML files to a single YML file,
# and then add the rest Discourse YML files to Git": https://github.com/dmitrii-fediuk/5.9.188.84/issues/60
  - "credentials.yml"
  - "templates/postgres.template.yml"
  - "templates/redis.template.yml"
  - "templates/sshd.template.yml"
  - "templates/web.template.yml"
## These containers are stateless, all data is stored in /shared
volumes:
  - volume:
      guest: /shared
      host: /usr/local/discourse/shared/mage2.pro
  - volume:
      guest: /var/log
      host: /usr/local/discourse/shared/mage2.pro/log/var-log